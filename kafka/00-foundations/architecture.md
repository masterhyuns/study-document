# 🏗️ Apache Kafka 아키텍처 상세 가이드

## 📐 전체 아키텍처 Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           Apache Kafka Ecosystem                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                  │
│  │  Producers   │  │  Producers   │  │  Producers   │                  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                  │
│         │                  │                  │                          │
│         └──────────────────┼──────────────────┘                          │
│                            ▼                                             │
│  ┌────────────────────────────────────────────────────────────────┐     │
│  │                     Kafka Cluster                              │     │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │     │
│  │  │   Broker 1  │  │   Broker 2  │  │   Broker 3  │           │     │
│  │  │  ┌────────┐ │  │  ┌────────┐ │  │  ┌────────┐ │           │     │
│  │  │  │Topic A │ │  │  │Topic A │ │  │  │Topic B │ │           │     │
│  │  │  │Part 0  │ │  │  │Part 1  │ │  │  │Part 0  │ │           │     │
│  │  │  └────────┘ │  │  └────────┘ │  │  └────────┘ │           │     │
│  │  │  ┌────────┐ │  │  ┌────────┐ │  │  ┌────────┐ │           │     │
│  │  │  │Topic B │ │  │  │Topic C │ │  │  │Topic C │ │           │     │
│  │  │  │Part 1  │ │  │  │Part 0  │ │  │  │Part 1  │ │           │     │
│  │  │  └────────┘ │  │  └────────┘ │  │  └────────┘ │           │     │
│  │  └─────────────┘  └─────────────┘  └─────────────┘           │     │
│  │                                                                │     │
│  │                     ZooKeeper Ensemble                        │     │
│  │  ┌───────────┐    ┌───────────┐    ┌───────────┐            │     │
│  │  │ ZooKeeper │◄───┤ ZooKeeper │───►│ ZooKeeper │            │     │
│  │  │   Node 1  │    │   Node 2  │    │   Node 3  │            │     │
│  │  └───────────┘    └───────────┘    └───────────┘            │     │
│  └────────────────────────────────────────────────────────────────┘     │
│                            ▲                                             │
│         ┌──────────────────┼──────────────────┐                          │
│         │                  │                  │                          │
│  ┌──────┴───────┐  ┌──────┴───────┐  ┌──────┴───────┐                  │
│  │  Consumers   │  │  Consumers   │  │  Consumers   │                  │
│  └──────────────┘  └──────────────┘  └──────────────┘                  │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

## 🔍 컴포넌트별 상세 설명

### 1. Broker (브로커) 상세 구조

```
┌─────────────────────────────────────────────────┐
│                  Kafka Broker                    │
├─────────────────────────────────────────────────┤
│                                                  │
│  ┌─────────────────────────────────────────┐    │
│  │         Network Layer                    │    │
│  │  ┌──────────┐  ┌───────────────────┐   │    │
│  │  │ Acceptor │  │ Processor Threads │   │    │
│  │  └─────┬────┘  └────────┬──────────┘   │    │
│  └────────┼─────────────────┼──────────────┘    │
│           │                 │                    │
│  ┌────────▼─────────────────▼──────────────┐    │
│  │         Request Handler Pool            │    │
│  │  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ │    │
│  │  │Thread│ │Thread│ │Thread│ │Thread│ │    │
│  │  └──┬───┘ └──┬───┘ └──┬───┘ └──┬───┘ │    │
│  └─────┼────────┼───────┼───────┼────────┘    │
│        └────────┴───────┴───────┘               │
│                 │                                │
│  ┌──────────────▼──────────────────────────┐    │
│  │           Log Manager                    │    │
│  │  ┌───────────────────────────────────┐  │    │
│  │  │     Log Segments Storage          │  │    │
│  │  │  ┌──────────┐  ┌──────────┐     │  │    │
│  │  │  │Segment 1 │  │Segment 2 │     │  │    │
│  │  │  │(.log)    │  │(.log)    │     │  │    │
│  │  │  │(.index)  │  │(.index)  │     │  │    │
│  │  │  └──────────┘  └──────────┘     │  │    │
│  │  └───────────────────────────────────┘  │    │
│  └──────────────────────────────────────────┘    │
│                                                  │
│  ┌──────────────────────────────────────────┐    │
│  │         Replication Manager              │    │
│  │  ┌─────────────┐  ┌─────────────┐      │    │
│  │  │Leader Replica│  │Follower     │      │    │
│  │  │Management   │  │Replication  │      │    │
│  │  └─────────────┘  └─────────────┘      │    │
│  └──────────────────────────────────────────┘    │
│                                                  │
└─────────────────────────────────────────────────┘
```

### 2. Topic과 Partition 구조

```
Topic: "order-events" (Replication Factor = 3)
┌────────────────────────────────────────────────────┐
│                                                    │
│  Partition 0                                       │
│  ┌─────────────────────────────────────────────┐  │
│  │ Leader (Broker 1)                           │  │
│  │ ┌───┬───┬───┬───┬───┬───┬───┬───┬───┐    │  │
│  │ │ 0 │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │...│    │  │
│  │ └───┴───┴───┴───┴───┴───┴───┴───┴───┘    │  │
│  └─────────────────────────────────────────────┘  │
│  ┌─────────────────────────────────────────────┐  │
│  │ Follower (Broker 2)                         │  │
│  │ ┌───┬───┬───┬───┬───┬───┬───┬───┬───┐    │  │
│  │ │ 0 │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │...│    │  │
│  │ └───┴───┴───┴───┴───┴───┴───┴───┴───┘    │  │
│  └─────────────────────────────────────────────┘  │
│  ┌─────────────────────────────────────────────┐  │
│  │ Follower (Broker 3)                         │  │
│  │ ┌───┬───┬───┬───┬───┬───┬───┬───┬───┐    │  │
│  │ │ 0 │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │...│    │  │
│  │ └───┴───┴───┴───┴───┴───┴───┴───┴───┘    │  │
│  └─────────────────────────────────────────────┘  │
│                                                    │
│  Partition 1                                       │
│  ┌─────────────────────────────────────────────┐  │
│  │ Leader (Broker 2)                           │  │
│  │ ┌───┬───┬───┬───┬───┬───┬───┬───┬───┐    │  │
│  │ │ 0 │ 1 │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │...│    │  │
│  │ └───┴───┴───┴───┴───┴───┴───┴───┴───┘    │  │
│  └─────────────────────────────────────────────┘  │
│  ...                                               │
└────────────────────────────────────────────────────┘
```

### 3. 데이터 저장 구조 (Log Segments)

```
/kafka-logs/
├── order-events-0/           # Partition 0
│   ├── 00000000000000000000.log     # 첫 번째 세그먼트
│   ├── 00000000000000000000.index   # 오프셋 인덱스
│   ├── 00000000000000000000.timeindex # 타임스탬프 인덱스
│   ├── 00000000000000001024.log     # 두 번째 세그먼트
│   ├── 00000000000000001024.index
│   └── 00000000000000001024.timeindex
│
└── order-events-1/           # Partition 1
    ├── 00000000000000000000.log
    ├── 00000000000000000000.index
    └── 00000000000000000000.timeindex

세그먼트 파일 구조:
┌─────────────────────────────────────┐
│         Log Segment File            │
├─────────────────────────────────────┤
│ Message 1: [Offset][Size][CRC]     │
│           [Timestamp][Key][Value]   │
├─────────────────────────────────────┤
│ Message 2: [Offset][Size][CRC]     │
│           [Timestamp][Key][Value]   │
├─────────────────────────────────────┤
│ Message 3: [Offset][Size][CRC]     │
│           [Timestamp][Key][Value]   │
└─────────────────────────────────────┘
```

## 🔄 데이터 플로우 상세

### Producer → Kafka 데이터 전송 과정

```
Producer Application
        │
        ▼
┌──────────────────┐
│ 1. Serialize     │ (객체 → 바이트 배열)
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 2. Partition     │ (파티션 결정)
│    Selection     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 3. Record        │ (배치 처리를 위한 버퍼링)
│    Accumulator   │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 4. Network       │ (브로커로 전송)
│    Client        │
└────────┬─────────┘
         │
         ▼
   Kafka Broker
         │
         ▼
┌──────────────────┐
│ 5. Append to     │ (로그에 추가)
│    Log           │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 6. Replication   │ (팔로워로 복제)
└──────────────────┘
```

### Kafka → Consumer 데이터 읽기 과정

```
Consumer Application
        │
        ▼
┌──────────────────┐
│ 1. Subscribe     │ (토픽 구독)
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 2. Group         │ (그룹 코디네이터와 통신)
│    Coordination  │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 3. Partition     │ (파티션 할당)
│    Assignment    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 4. Fetch         │ (브로커에서 데이터 가져오기)
│    Request       │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 5. Deserialize   │ (바이트 배열 → 객체)
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 6. Process       │ (비즈니스 로직 처리)
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 7. Commit        │ (오프셋 커밋)
│    Offset        │
└──────────────────┘
```

## 🔐 복제(Replication) 메커니즘

```
        Write Request
              │
              ▼
        ┌──────────┐
        │  Leader  │ (Broker 1)
        │  Replica │
        └────┬─────┘
             │
    ┌────────┼────────┐
    │                 │
    ▼                 ▼
┌──────────┐    ┌──────────┐
│ Follower │    │ Follower │
│ Replica  │    │ Replica  │
│(Broker 2)│    │(Broker 3)│
└──────────┘    └──────────┘

ISR (In-Sync Replicas) 관리:
┌─────────────────────────────────┐
│        ISR List                 │
│  ✓ Leader (Broker 1)           │
│  ✓ Follower (Broker 2) - Synced│
│  ✗ Follower (Broker 3) - Lagging│
└─────────────────────────────────┘
```

## 🎛️ ZooKeeper의 역할

```
                ZooKeeper Ensemble
┌─────────────────────────────────────────┐
│                                         │
│  /kafka                                 │
│  ├── /brokers                          │
│  │   ├── /ids                          │
│  │   │   ├── 1 (broker metadata)       │
│  │   │   ├── 2 (broker metadata)       │
│  │   │   └── 3 (broker metadata)       │
│  │   └── /topics                       │
│  │       ├── order-events              │
│  │       │   └── /partitions           │
│  │       │       ├── 0                 │
│  │       │       │   └── state         │
│  │       │       └── 1                 │
│  │       │           └── state         │
│  │       └── user-events               │
│  │                                     │
│  ├── /consumers                        │
│  │   └── /analytics-group              │
│  │       ├── /ids                      │
│  │       └── /offsets                  │
│  │                                     │
│  └── /controller                       │
│      └── 2 (current controller)        │
│                                         │
└─────────────────────────────────────────┘
```

## 📊 성능 최적화 포인트

### 1. Zero-Copy 전송
```
Traditional:
Disk → Kernel Buffer → User Buffer → Socket Buffer → Network

Zero-Copy:
Disk → Kernel Buffer → Network (sendfile() 시스템 콜 사용)
```

### 2. 배치 처리
```
개별 전송:
[msg] → send() → Network
[msg] → send() → Network
[msg] → send() → Network

배치 전송:
[msg][msg][msg] → send() → Network
```

### 3. 페이지 캐시 활용
```
┌─────────────────┐
│  Application    │
└────────┬────────┘
         │ read()
         ▼
┌─────────────────┐
│  Page Cache     │ ← OS가 자동 관리
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│     Disk        │
└─────────────────┘
```

## 🔧 컨트롤러 (Controller) 역할

```
         Controller Election
              │
              ▼
        ┌──────────┐
        │Controller│ (선출된 브로커)
        │ Broker 2 │
        └────┬─────┘
             │
    ┌────────┼─────────┬──────────┐
    │        │         │          │
    ▼        ▼         ▼          ▼
 파티션    리더      브로커    토픽
 할당     선출     추가/제거   생성/삭제

Controller 책임:
1. 파티션 리더 선출
2. ISR 리스트 관리
3. 파티션 재할당
4. 브로커 장애 감지 및 처리
```

## 🚀 Kafka 3.x 변화 (KRaft Mode)

```
기존 아키텍처 (with ZooKeeper):
┌─────────┐     ┌───────────┐
│  Kafka  │────▶│ ZooKeeper │
└─────────┘     └───────────┘

새로운 아키텍처 (KRaft):
┌─────────────────────────┐
│   Kafka with KRaft      │
│  (내장 메타데이터 관리)    │
└─────────────────────────┘

장점:
- 단일 시스템으로 단순화
- 더 빠른 컨트롤러 페일오버
- 확장성 향상 (더 많은 파티션 지원)
```

## 📈 모니터링 핵심 메트릭

```
┌─────────────────────────────────────┐
│         JMX Metrics                 │
├─────────────────────────────────────┤
│ Broker Metrics:                     │
│ • Messages In/Out Rate              │
│ • Bytes In/Out Rate                 │
│ • Request Rate & Latency            │
│ • ISR Shrink/Expand Rate            │
│                                     │
│ Topic/Partition Metrics:            │
│ • Log Size                          │
│ • Log Segment Count                 │
│ • Under Replicated Partitions       │
│                                     │
│ Consumer Metrics:                   │
│ • Lag (현재 오프셋 vs 최신 오프셋)     │
│ • Fetch Rate                        │
│ • Commit Rate                       │
└─────────────────────────────────────┘
```

---

💡 **핵심 포인트**: 카프카의 아키텍처는 **분산**, **복제**, **내구성**을 중심으로 설계되어 있으며, 각 컴포넌트는 독립적으로 확장 가능하도록 구성되어 있습니다.